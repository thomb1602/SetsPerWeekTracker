<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Workout</title>
    <!-- Include common styles -->
    <link rel="stylesheet" href="styles.css">
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Include PapaParse library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

</head>
<body>
    <div id="add-workout-container">
        <h1>Add Workout</h1>

        <!-- Date Picker -->
        <label for="datepicker">Select Date:</label>
        <input type="date" id="datepicker" name="datepicker" required>

        <!-- Container for Exercise Elements -->
        <div id="exercise-container"></div>

        <!-- Add Exercise Button -->
        <div class="button-container">
            <button class="button" id="add-exercise-btn">Add Exercise</button>
        </div>

    </div>

    <script>

        $(document).ready(function() {
            // Counter for unique IDs
            var exerciseCount = 0;
            var saveWorkoutButtonAdded = false;

            // Function to load exercises from CSV
        function loadExercises(dropdown) {
            Papa.parse("exercises.csv", {
                header: true,
                download: true,
                dynamicTyping: true,
                complete: function (results) {
                    // Organize exercises by primary area
                    var exercisesByPrimaryArea = {};
                    results.data.forEach(function (exercise) {
                        var primaryArea = exercise.PrimaryArea || "Other";
                        if (!exercisesByPrimaryArea[primaryArea]) {
                            exercisesByPrimaryArea[primaryArea] = [];
                        }
                        exercisesByPrimaryArea[primaryArea].push(exercise);
                    });

                    // Populate dropdown with exercise options and subheadings
                    for (var primaryArea in exercisesByPrimaryArea) {
                        // Add subheading for primary area
                        dropdown.append($('<optgroup>', {
                            label: primaryArea,
                        }));

                        // Add exercises under the subheading
                        exercisesByPrimaryArea[primaryArea].forEach(function (exercise) {
                            dropdown.append($('<option>', {
                                value: exercise.ID,
                                text: exercise.Exercise
                            }));
                        });
                    }
                }
            });
        }

        // Function to get the list of existing CSV files
        async function getWeekCsvFiles() {
                var indexPath = "stats/index.txt";
                const filesPromise = await fetch(indexPath);
                const files = await filesPromise.text();
                const filenameRegex = /[0-9]*-[0-9]*.csv/g;
                const filenames = files.split(/\r?\n/);
                return filenames;
            }

            
            // Event listener for the "Add Exercise" button
            $('#add-exercise-btn').on('click', function() {
                // Increment the counter for unique IDs
                exerciseCount++;

                // Create the dropdown element
                var dropdown = $('<select>', {
                    id: 'exercise-dropdown-' + exerciseCount,
                    name: 'exercise-dropdown',
                    class: 'exercise-dropdown',
                });
                // Load exercises when the page is ready
                loadExercises(dropdown);

                // Create the text input for the number of sets
                var setsInput = $('<input>', {
                    type: 'number',
                    id: 'sets-input-' + exerciseCount,
                    name: 'sets-input',
                    class: 'sets-input',
                    placeholder: 'Number of sets',
                    min: 1, // Minimum value
                    required: true,
                });

                // Create the remove icon (you can replace this with your preferred icon library)
                var removeIcon = $('<span>', {
                    class: 'remove-icon',
                    html: '&#10006;', // Unicode for a red cross
                });

                // Container for the exercise elements
                var exerciseElement = $('<div>', {
                    class: 'exercise-element',
                });

                // Append the elements to the container
                exerciseElement.append($('#exercise-dropdown').clone().prop('id', 'exercise-dropdown-' + exerciseCount));
                exerciseElement.append(dropdown, setsInput, removeIcon);

                // Append the container to the exercise container
                $('#exercise-container').append(exerciseElement);

                // Show the "Save Workout" button if it's not already present
                if ($('#save-workout-btn').length === 0) {
                    $('.button-container').append('<button class="button" id="save-workout-btn">Save Workout</button>');
                    // Event listener for the "Save Workout" button
                    $('#save-workout-btn').on('click', async function () {
                        // Get the selected date
                        var selectedDate = $('#datepicker').val();
                        var filenames = await getWeekCsvFiles();
                        console.log("Existing files:", filenames);
                        // Logic to check if a file already exists for the selected week
                        // If it doesn't, create a new file
                        if (!filenames.some(file => selectedDate >= file.split('-')[0] && selectedDate <= file.split('-')[1])) {
                            var newFilename = getMonday(selectedDate) + '-' + getSunday(selectedDate) + '.csv';
                            console.log("Creating new file:", newFilename);
                            // Save the workout data to the new file (placeholder for now)
                            // Replace this with the logic to save the actual form input
                            saveWorkoutData(newFilename);
                        } else {
                            // Find the existing file for the selected week
                            var existingFilename = filenames.find(file => selectedDate >= file.split('-')[0] && selectedDate <= file.split('-')[1]);
                            console.log("Appending to existing file:", existingFilename);
                            // Save the workout data to the existing file (placeholder for now)
                            // Replace this with the logic to save the actual form input
                            saveWorkoutData(existingFilename);
                        }
                    });
                }

                // Event listener for the remove icon
                removeIcon.on('click', function() {
                    exerciseElement.remove();
                    // Hide the "Save Workout" button if there are no exercise elements left
                    if ($('#exercise-container').children().length === 0) {
                        $('#save-workout-btn').hide();
                    }
                });
                
            });

            // Function to save workout data to a CSV file (placeholder for now)
            async function saveWorkoutData(filename) {
                console.log("Saving workout data to file:", filename);
                // Get the list of existing CSV files
                var filenames = await getWeekCsvFiles();
                console.log("Existing files:", filenames);

                // todo: get from config. or make the router never change this lol
                const serverURL = 'http://192.168.1.222:3000';
                
                // Check if the filename is not listed in index.txt
                if (!filenames.includes(filename)) {
                    console.log("File not listed in index.txt. Creating a new file.");
                    // Create a new file on the server
                    await fetch(`${serverURL}/saveWorkoutData`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ filename: filename, data: 'placeholder' }), // Replace 'placeholder' with actual workout data
                    });
                } else {
                    console.log("File already exists. Appending to the existing file.");
                    // Append the workout data to the existing file
                    await fetch(`${serverURL}/saveWorkoutData`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ filename: filename, data: 'placeholder' }), // Replace 'placeholder' with actual workout data
                    });
                }
            }

            // Function to get the Monday of the week for a given date
            function getMonday(date) {
                var d = new Date(date);
                var day = d.getDay();
                var diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
                var monday = new Date(d.setDate(diff));
                return formatDate(monday);
            }

            // Function to get the Sunday of the week for a given date
            function getSunday(date) {
                var d = new Date(date);
                var day = d.getDay();
                var diff = d.getDate() + (day === 0 ? 0 : 7 - day); // adjust when day is sunday
                var sunday = new Date(d.setDate(diff));
                return formatDate(sunday);
            }

            // Function to format a date as YYYYMMDD
            function formatDate(date) {
                var year = date.getFullYear();
                var month = (date.getMonth() + 1).toString().padStart(2, '0');
                var day = date.getDate().toString().padStart(2, '0');
                return year + month + day;
            }
       
        });
    </script>
</body>
</html>
