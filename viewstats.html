<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Stats</title>
    <!-- Include common styles -->
    <link rel="stylesheet" href="styles.css">
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Include PapaParse library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div id="view-stats-container">
        <h1>View Stats</h1>

        <div id="stats-content"></div>
    </div>

    <script>
        $(document).ready(function() {

            function loadCurrentWeek(exercises) {
                var currentCsvPath = "stats/20231113-20231119.csv"

                // Define a mapping between ExerciseId and PrimaryArea
                var exerciseMapping = {};
                exercises.data.forEach(function(exercise) {
                    exerciseMapping[exercise.ID] = exercise.PrimaryArea;
                });

                // Initialize an object to store the sum of sets for each PrimaryArea
                var setsByPrimaryArea = {};

                //start with chrome.exe --allow-file-access-from-files
                Papa.parse(currentCsvPath, {
                    header: true,
                    download: true,
                    dynamicTyping: true,
                    complete: function (results) {
                        results.data.forEach(function(row) {
                            var exerciseId = row.ExerciseId;
                            var numberOfSets = row.NumberOfSets;

                            // Look up the PrimaryArea for the current ExerciseId
                            var primaryArea = exerciseMapping[exerciseId];

                            // Accumulate the sets for each PrimaryArea
                            if (setsByPrimaryArea[primaryArea] === undefined) {
                                setsByPrimaryArea[primaryArea] = 0;
                            }
                            setsByPrimaryArea[primaryArea] += numberOfSets;
                        });

                        // Display the result (for now, just log to console)
                        console.log(setsByPrimaryArea);
                        // Display the result on the page
                        displayStats(setsByPrimaryArea);
                    }
                });
            }

            function displayStats(setsByPrimaryArea) {
                var statsContent = $('#stats-content');

                // Convert the setsByPrimaryArea object to an array of objects
                var primaryAreasArray = Object.keys(setsByPrimaryArea).map(function(primaryArea) {
                    return { primaryArea: primaryArea, sets: setsByPrimaryArea[primaryArea] };
                });

                // Sort the array based on the number of sets in descending order
                primaryAreasArray.sort(function(a, b) {
                    return b.sets - a.sets;
                });

                // Iterate through each PrimaryArea in the sorted order
                primaryAreasArray.forEach(function(item) {
                    // Create a div for each PrimaryArea
                    var div = $('<div>', {
                        class: 'primary-area-stats',
                    });

                    // Add heading for the PrimaryArea
                    div.append($('<h2>', {
                        text: item.primaryArea,
                    }));

                    // Add the sets information
                    div.append($('<p>', {
                        text: 'Primary area sets: ' + item.sets,
                    }));

                    // Append the div to the statsContent
                    statsContent.append(div);
                });
            }

            function loadExercises() {
                return new Promise(function(resolve) {
                    Papa.parse("exercises.csv", {
                        header: true,
                        download: true,
                        dynamicTyping: true,
                        complete: function (results) {
                            resolve(results);
                        }
                    });
                });
            }

            loadExercises().then(function(exercises) {
                loadCurrentWeek(exercises);
            });
        })
            
    </script>
</body>
</html>
